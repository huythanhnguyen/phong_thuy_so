<template>
  <div class="min-h-screen flex flex-col">
      <!-- Header -->
    <Header />

    <main class="flex-grow container mx-auto px-4 py-12">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Ch·ªçn S·ªë ƒêi·ªán Tho·∫°i H·ª£p Phong Th·ªßy</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
          <p class="text-lg text-gray-700 mb-6">
            S·ªë ƒëi·ªán tho·∫°i kh√¥ng ch·ªâ l√† m·ªôt d√£y s·ªë ƒë·ªÉ li√™n l·∫°c m√† c√≤n c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn nƒÉng l∆∞·ª£ng, v·∫≠n m·ªánh v√† c√°c kh√≠a c·∫°nh trong cu·ªôc s·ªëng c·ªßa b·∫°n theo quan ƒëi·ªÉm phong th·ªßy.
          </p>
          
          <div class="border-l-4 border-primary p-4 bg-primary-light mb-8">
            <h3 class="font-bold text-lg mb-2">L∆∞u √Ω quan tr·ªçng</h3>
            <p>Hi·ªán nay nhi·ªÅu nh√† m·∫°ng cho ph√©p kh√°ch h√†ng ch·ªçn s·ªë ƒëi·ªán tho·∫°i. Vi·ªác ch·ªçn m·ªôt s·ªë ƒëi·ªán tho·∫°i h·ª£p phong th·ªßy c√≥ th·ªÉ mang l·∫°i nhi·ªÅu may m·∫Øn, thu·∫≠n l·ª£i.</p>
          </div>
          
          <div class="border-l-4 border-yellow-500 p-4 bg-yellow-50 mb-8">
            <h3 class="font-bold text-lg text-yellow-700 mb-2">C√°c nguy√™n t·∫Øc ch·ªçn s·ªë ƒëi·ªán tho·∫°i</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-700">
              <li><strong>Ph∆∞∆°ng ph√°p ph√¢n t√≠ch:</strong> D√£y s·ªë ƒë∆∞·ª£c ph√¢n t√≠ch t·ª´ng c·∫∑p t·ª´ tr√°i qua ph·∫£i, ƒë·∫∑c bi·ªát quan tr·ªçng l√† c·∫∑p s·ªë cu·ªëi</li>
              <li><strong>Sinh Kh√≠</strong> (14, 41, 39, 93) th√≠ch h·ª£p cho s·ª©c kh·ªèe, nƒÉng l∆∞·ª£ng t√≠ch c·ª±c</li>
              <li><strong>Thi√™n Y</strong> (13, 31) mang ƒë·∫øn may m·∫Øn v·ªÅ t√†i l·ªôc, ti·ªÅn b·∫°c</li>
              <li><strong>Di√™n Ni√™n</strong> (19, 91, 34, 43) th√≠ch h·ª£p cho s·ª± nghi·ªáp ·ªïn ƒë·ªãnh, b·ªÅn v·ªØng</li>
              <li><strong>L∆∞u √Ω:</strong> Tr√°nh k·∫øt th√∫c b·∫±ng s·ªë 0 ho·∫∑c c√°c hung tinh (Ng≈© Qu·ª∑, Tuy·ªát M·ªánh, L·ª•c S√°t, H·ªça H·∫°i)</li>
              <li><strong>ƒê·∫∑c bi·ªát:</strong> N·∫øu k·∫øt th√∫c b·∫±ng s·ªë 5, c·∫∑p s·ªë tr∆∞·ªõc ph·∫£i l√† c√°t tinh ph√π h·ª£p v·ªõi m·ª•c ƒë√≠ch s·ª≠ d·ª•ng</li>
              <li><strong>C√¢n b·∫±ng √¢m d∆∞∆°ng:</strong> M·ªôt s·ªë hung tinh khi k·∫øt h·ª£p kh√©o l√©o v·ªõi c√°c c√°t tinh c√≥ th·ªÉ t·∫°o n√™n s·ª± c√¢n b·∫±ng √¢m d∆∞∆°ng t·ªët</li>
            </ul>
          </div>
          </div>
          
        <!-- Ph·∫ßn ch·ªçn ƒë·∫ßu s·ªë -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">ƒê·∫ßu s·ªë mong mu·ªën</h2>
          <p class="mb-4">Ch·ªçn ƒë·∫ßu s·ªë nh√† m·∫°ng b·∫°n mong mu·ªën</p>
          
          <div class="grid md:grid-cols-4 gap-4 mb-6">
            <div 
              v-for="(provider, index) in providers" 
              :key="index"
              class="border rounded-lg p-4 cursor-pointer transition-all duration-300"
              :class="selectedProvider === provider.value ? 'border-primary bg-primary-light shadow-md' : 'border-gray-200 hover:border-primary hover:shadow'"
              @click="selectedProvider = provider.value"
            >
              <div class="flex items-center">
                <div class="w-5 h-5 rounded-full border mr-3 flex items-center justify-center" 
                     :class="selectedProvider === provider.value ? 'border-primary' : 'border-gray-400'">
                  <div v-if="selectedProvider === provider.value" class="w-3 h-3 rounded-full bg-primary"></div>
                </div>
                <span>{{ provider.label }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Ph·∫ßn ch·ªçn m·ª•c ƒë√≠ch -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">M·ª•c ti√™u mong mu·ªën</h2>
          <p class="mb-4">Ch·ªçn m·ª•c ti√™u b·∫°n mu·ªën s·ªë ƒëi·ªán tho·∫°i h·ªó tr·ª£</p>
          
          <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div 
              v-for="(purpose, index) in purposes" 
              :key="index"
              class="border rounded-lg p-4 cursor-pointer transition-all duration-300"
              :class="selectedPurpose === purpose.value ? 'border-primary bg-primary-light shadow-md' : 'border-gray-200 hover:border-primary hover:shadow'"
              @click="selectedPurpose = purpose.value"
            >
              <div class="flex items-center">
                <div class="w-5 h-5 rounded-full border mr-3 flex items-center justify-center" 
                     :class="selectedPurpose === purpose.value ? 'border-primary' : 'border-gray-400'">
                  <div v-if="selectedPurpose === purpose.value" class="w-3 h-3 rounded-full bg-primary"></div>
                </div>
                <span>{{ purpose.label }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Ph·∫ßn t√πy ch·ªçn n√¢ng cao -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">T√πy ch·ªçn n√¢ng cao</h2>
          <div class="flex items-center mb-4">
            <input 
              type="checkbox" 
              id="includeNegativeStar" 
              v-model="includeNegativeStar"
              class="w-5 h-5 text-primary rounded border-gray-300 focus:ring-primary"
            >
            <label for="includeNegativeStar" class="ml-2 block text-gray-700">
              Th√™m m·ªôt hung tinh ƒë·ªÉ c√¢n b·∫±ng √¢m d∆∞∆°ng (kh√¥ng ·ªü v·ªã tr√≠ cu·ªëi)
            </label>
          </div>
          <p class="text-sm text-gray-600 ml-7">
            Vi·ªác k·∫øt h·ª£p kh√©o l√©o m·ªôt hung tinh v·ªõi c√°c c√°t tinh c√≥ th·ªÉ t·∫°o n√™n s·ª± c√¢n b·∫±ng √¢m d∆∞∆°ng, t∆∞∆°ng sinh h·ªó tr·ª£ cho m·ª•c ƒë√≠ch c·ªßa b·∫°n:
            <br>‚Ä¢ <strong>Ng≈© Qu·ª∑, Tuy·ªát M·ªánh</strong> - TƒÉng c∆∞·ªùng nƒÉng l∆∞·ª£ng d∆∞∆°ng, kh·∫£ nƒÉng quy·∫øt ƒëo√°n
            <br>‚Ä¢ <strong>L·ª•c S√°t</strong> (38, 83, 52, 25) - TƒÉng c∆∞·ªùng nƒÉng l∆∞·ª£ng √¢m (n·ªØ t√≠nh)
            <br>‚Ä¢ <strong>H·ªça H·∫°i</strong> (47, 74) - TƒÉng c∆∞·ªùng kh·∫£ nƒÉng bi·ªÉu ƒë·∫°t, giao ti·∫øp
            <br>Hung tinh s·∫Ω kh√¥ng ƒë∆∞·ª£c ƒë·∫∑t ·ªü c·∫∑p s·ªë cu·ªëi c√πng.
          </p>
                </div>

        <!-- Ph·∫ßn g·ª£i √Ω s·ªë ƒëi·ªán tho·∫°i -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">S·ªë ƒëi·ªán tho·∫°i g·ª£i √Ω</h2>
          
          <div v-if="!selectedPurpose || !selectedProvider" class="text-center py-6 text-gray-500">
            Vui l√≤ng ch·ªçn ƒë·∫ßu s·ªë v√† m·ª•c ti√™u ƒë·ªÉ nh·∫≠n g·ª£i √Ω
                  </div>
          
          <div v-else>
            <div class="mb-6">
              <p class="mb-2">C·∫∑p sao t∆∞∆°ng ·ª©ng: <span class="font-semibold">{{ getStars() }}</span></p>
              <p class="mt-2 text-gray-600 text-sm">{{ getPurposeDescription() }}</p>
              <div class="mt-4 border-l-4 border-primary p-4 bg-primary-light">
                <h4 class="font-bold mb-2">C·∫∑p s·ªë cu·ªëi ph√π h·ª£p</h4>
                <p class="text-sm" v-if="selectedPurpose === 'wealth'">
                  D√πng <strong>Thi√™n Y</strong> (13, 31, 68, 86) ·ªü cu·ªëi s·ªë ƒëi·ªán tho·∫°i gi√∫p thu h√∫t t√†i l·ªôc, th·ªãnh v∆∞·ª£ng.
                </p>
                <p class="text-sm" v-else-if="selectedPurpose === 'health'">
                  D√πng <strong>Sinh Kh√≠</strong> (14, 41, 39, 93) ·ªü cu·ªëi s·ªë ƒëi·ªán tho·∫°i gi√∫p tƒÉng c∆∞·ªùng s·ª©c kh·ªèe, nƒÉng l∆∞·ª£ng.
                </p>
                <p class="text-sm" v-else-if="selectedPurpose === 'career'">
                  D√πng <strong>Di√™n Ni√™n</strong> (19, 91, 34, 43) ·ªü cu·ªëi s·ªë ƒëi·ªán tho·∫°i gi√∫p s·ª± nghi·ªáp ·ªïn ƒë·ªãnh, ph√°t tri·ªÉn b·ªÅn v·ªØng.
                </p>
                <p class="text-sm" v-else-if="selectedPurpose === 'relationship'">
                  D√πng <strong>Ph·ª•c V·ªã</strong> (11, 33, 77, 99) ·ªü cu·ªëi s·ªë ƒëi·ªán tho·∫°i gi√∫p c√°c m·ªëi quan h·ªá, duy√™n ph·∫≠n t·ªët ƒë·∫πp.
                </p>
                  </div>
                </div>
            
            <div class="grid md:grid-cols-2 gap-4 mb-6">
              <div v-for="(phone, index) in suggestedPhoneNumbers" :key="index" 
                class="border border-gray-200 rounded-lg p-4 relative hover:shadow-md transition-shadow">
                <div class="text-xl font-mono mb-2 text-center">{{ phone }}</div>
                <div class="text-xs text-gray-500 text-center mb-2">{{ phoneExplanations[index] }}</div>
                <button 
                  @click="copyToClipboard(phone)" 
                  class="absolute top-2 right-2 text-gray-500 hover:text-primary"
                  title="Sao ch√©p"
                >
                  <span>üìã</span>
                </button>
              </div>
            </div>
            
            <div class="text-center">
              <button 
                @click="generatePhoneNumbers" 
                class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors shadow-md"
              >
                G·ª£i √Ω s·ªë kh√°c
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <Footer />
  </div>
</template>

<script setup>
import { ref, watch } from 'vue'
import Header from '@/components/layout/Header.vue'
import Footer from '@/components/layout/Footer.vue'

// Tr·∫°ng th√°i
const selectedProvider = ref('')
const selectedPurpose = ref('')
const suggestedPhoneNumbers = ref([])
const phoneExplanations = ref([])
const includeNegativeStar = ref(false)

// Danh s√°ch nh√† m·∫°ng
const providers = [
  { value: '086', label: 'Viettel (086)' },
  { value: '088', label: 'Vinaphone (088)' },
  { value: '089', label: 'Mobifone (089)' },
  { value: '090', label: 'Mobifone (090)' },
  { value: '091', label: 'Vinaphone (091)' },
  { value: '094', label: 'Viettel (094)' },
  { value: '097', label: 'Viettel (097)' },
  { value: '098', label: 'Viettel (098)' },
]

// Danh s√°ch m·ª•c ti√™u
const purposes = [
  { value: 'wealth', label: 'T√†i l·ªôc' },
  { value: 'health', label: 'S·ª©c kh·ªèe' },
  { value: 'career', label: 'S·ª± nghi·ªáp' },
  { value: 'relationship', label: 'H√¥n nh√¢n, T√¨nh duy√™n' }
]

// D·ªØ li·ªáu phong th·ªßy
const fengShuiData = {
  wealth: {
    stars: 'Thi√™n Y',
    luckyNumbers: ['1', '3', '6', '8', '9'], 
    combinations: ['13', '31', '68', '86', '49', '94'],
    description: 'S·ªë ƒëi·ªán tho·∫°i c√≥ c·∫∑p s·ªë Thi√™n Y gi√∫p thu h√∫t t√†i l·ªôc, ti·ªÅn b·∫°c d·ªìi d√†o v√† c∆° h·ªôi l√†m ƒÉn.'
  },
  health: {
    stars: 'Sinh Kh√≠',
    luckyNumbers: ['1', '4', '3', '9', '8', '2'], 
    combinations: ['14', '41', '39', '93', '67', '76'],
    description: 'S·ªë ƒëi·ªán tho·∫°i c√≥ c·∫∑p s·ªë Sinh Kh√≠ gi√∫p tƒÉng c∆∞·ªùng s·ª©c kh·ªèe, nƒÉng l∆∞·ª£ng t√≠ch c·ª±c.'
  },
  career: {
    stars: 'Di√™n Ni√™n',
    luckyNumbers: ['1', '9', '3', '4', '7', '8'], 
    combinations: ['19', '91', '34', '43', '78', '87'],
    description: 'S·ªë ƒëi·ªán tho·∫°i c√≥ c·∫∑p s·ªë Di√™n Ni√™n gi√∫p s·ª± nghi·ªáp ·ªïn ƒë·ªãnh, ph√°t tri·ªÉn b·ªÅn v·ªØng.'
  },
  relationship: {
    stars: 'Ph·ª•c V·ªã + Sinh Kh√≠',
    luckyNumbers: ['1', '3', '7', '9'], 
    combinations: ['11', '33', '77', '99', '14', '41'],
    description: 'S·ªë ƒëi·ªán tho·∫°i c√≥ c·∫∑p s·ªë Ph·ª•c V·ªã ho·∫∑c Sinh Kh√≠ gi√∫p c√°c m·ªëi quan h·ªá, duy√™n ph·∫≠n t·ªët ƒë·∫πp.'
  }
}

// C·∫∑p s·ªë t∆∞∆°ng ·ª©ng v·ªõi c√°c sao
const starNumbers = {
  'SINH_KHI': ['14', '41', '67', '76', '39', '93', '28', '82'],
  'THIEN_Y': ['13', '31', '68', '86', '49', '94', '27', '72'],
  'DIEN_NIEN': ['19', '91', '78', '87', '34', '43', '26', '62'],
  'NGU_QUY': ['18', '81', '79', '97', '36', '63', '24', '42'],
  'TUYET_MENH': ['12', '21', '69', '96', '84', '48', '73', '37'],
  'PHUC_VI': ['11', '22', '33', '44', '55', '66', '77', '88', '99'],
  'LUC_SAT': ['38', '83', '52', '25', '61', '16'], // Th√™m L·ª•c S√°t
  'HOA_HAI': ['47', '74', '29', '92', '56', '65'] // Th√™m H·ªça H·∫°i
}

// Ph∆∞∆°ng th·ª©c
const getStars = () => {
  return selectedPurpose.value ? fengShuiData[selectedPurpose.value].stars : ''
}

const getPurposeDescription = () => {
  return selectedPurpose.value ? fengShuiData[selectedPurpose.value].description : ''
}

const getNegativeStarForBalance = (previousDigit, forbiddenPairs = []) => {
  // Danh s√°ch c√°c hung tinh
  const allNegativeStars = [
    ...starNumbers.NGU_QUY, 
    ...starNumbers.TUYET_MENH,
    ...starNumbers.LUC_SAT,
    ...starNumbers.HOA_HAI
  ];
  
  // L·ªçc ra c√°c c·∫∑p hung tinh m√† kh√¥ng n·∫±m trong danh s√°ch c·∫•m
  const validNegativeStars = allNegativeStars.filter(pair => {
    // Ki·ªÉm tra pair kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng previousDigit ƒë·ªÉ kh√¥ng t·∫°o th√†nh 2 hung tinh li·ªÅn k·ªÅ
    if (pair.startsWith(previousDigit)) {
      for (const key of ['NGU_QUY', 'TUYET_MENH', 'LUC_SAT', 'HOA_HAI']) {
        if (starNumbers[key].some(p => p.endsWith(previousDigit))) {
          return false; // N·∫øu previousDigit l√† k·∫øt th√∫c c·ªßa 1 hung tinh, kh√¥ng ch·ªçn
        }
      }
    }
    
    return !forbiddenPairs.includes(pair);
  });
  
  if (validNegativeStars.length > 0) {
    // Ch·ªçn ng·∫´u nhi√™n m·ªôt c·∫∑p hung tinh
    const randomIndex = Math.floor(Math.random() * validNegativeStars.length);
    return validNegativeStars[randomIndex];
  }
  
  return null;
}

const generatePhoneExplanation = (phone) => {
  let explanation = "Ph√¢n t√≠ch: "
  const pairs = []
  
  // Ph√¢n t√≠ch d√£y s·ªë t·ª´ng c·∫∑p t·ª´ tr√°i qua ph·∫£i
  for (let i = 0; i < phone.length - 1; i++) {
    const pair = phone.substr(i, 2)
    let starType = ""
    
    // X√°c ƒë·ªãnh lo·∫°i sao
    if (starNumbers.SINH_KHI.includes(pair)) {
      starType = "Sinh Kh√≠"
    } else if (starNumbers.THIEN_Y.includes(pair)) {
      starType = "Thi√™n Y"
    } else if (starNumbers.DIEN_NIEN.includes(pair)) {
      starType = "Di√™n Ni√™n"
    } else if (starNumbers.NGU_QUY.includes(pair)) {
      starType = "Ng≈© Qu·ª∑"
    } else if (starNumbers.TUYET_MENH.includes(pair)) {
      starType = "Tuy·ªát M·ªánh"
    } else if (starNumbers.PHUC_VI.includes(pair)) {
      starType = "Ph·ª•c V·ªã"
    } else if (starNumbers.LUC_SAT.includes(pair)) {
      starType = "L·ª•c S√°t"
    } else if (starNumbers.HOA_HAI.includes(pair)) {
      starType = "H·ªça H·∫°i"
    } else {
      continue
    }
    
    pairs.push(`${pair}(${starType})`)
  }
  
  if (pairs.length > 0) {
    explanation += pairs.join(" + ")
  } else {
    explanation = "S·ªë ƒëi·ªán tho·∫°i phong th·ªßy theo m·ª•c ti√™u ƒë√£ ch·ªçn"
  }
  
  // Ki·ªÉm tra hung tinh
  let hasNegativeStar = false;
  let negativeStarType = "";
  
  for (const pair of pairs) {
    if (pair.includes("Ng≈© Qu·ª∑") || pair.includes("Tuy·ªát M·ªánh")) {
      hasNegativeStar = true;
      negativeStarType = pair.includes("Ng≈© Qu·ª∑") ? "Ng≈© Qu·ª∑" : "Tuy·ªát M·ªánh";
      break;
    } else if (pair.includes("L·ª•c S√°t")) {
      hasNegativeStar = true;
      negativeStarType = "L·ª•c S√°t";
      break;
    } else if (pair.includes("H·ªça H·∫°i")) {
      hasNegativeStar = true;
      negativeStarType = "H·ªça H·∫°i";
      break;
    }
  }
  
  if (includeNegativeStar.value) {
    if (hasNegativeStar) {
      let explanation_add = " - C√≥ hung tinh c√¢n b·∫±ng √¢m d∆∞∆°ng";
      
      if (negativeStarType === "L·ª•c S√°t") {
        explanation_add += " (L·ª•c S√°t tƒÉng c∆∞·ªùng nƒÉng l∆∞·ª£ng n·ªØ t√≠nh)";
      } else if (negativeStarType === "H·ªça H·∫°i") {
        explanation_add += " (H·ªça H·∫°i tƒÉng c∆∞·ªùng kh·∫£ nƒÉng giao ti·∫øp)";
      }
      
      explanation += explanation_add;
    } else {
      explanation += " - Ch∆∞a c√≥ hung tinh ƒë·ªÉ c√¢n b·∫±ng";
    }
  }
  
  // Ki·ªÉm tra s·ªë cu·ªëi c√πng
  const lastDigit = phone.slice(-1)
  if (lastDigit === '0') {
    explanation += " - L∆∞u √Ω: K·∫øt th√∫c b·∫±ng s·ªë 0 (kh√¥ng t·ªët)"
  }
  
  // Ki·ªÉm tra n·∫øu s·ªë cu·ªëi l√† 5, ki·ªÉm tra c·∫∑p s·ªë tr∆∞·ªõc
  if (lastDigit === '5') {
    const secondLastDigit = phone.slice(-2, -1)
    const prePair = phone.slice(-3, -1)
    let isAuspiciousPair = false
    
    for (const key of ['SINH_KHI', 'THIEN_Y', 'DIEN_NIEN', 'PHUC_VI']) {
      if (starNumbers[key].some(pair => pair.startsWith(secondLastDigit))) {
        isAuspiciousPair = true
        break
      }
    }
    
    if (!isAuspiciousPair) {
      explanation += " - L∆∞u √Ω: S·ªë 5 ·ªü cu·ªëi nh∆∞ng c·∫∑p s·ªë tr∆∞·ªõc kh√¥ng ph·∫£i c√°t tinh (kh√¥ng t·ªët)"
    } else {
      explanation += " - S·ªë 5 ·ªü cu·ªëi v·ªõi c·∫∑p s·ªë tr∆∞·ªõc l√† c√°t tinh (r·∫•t t·ªët)"
    }
  }
  
  // Ki·ªÉm tra n·∫øu c·∫∑p cu·ªëi l√† hung tinh
  const lastPair = phone.slice(-2)
  if (isNegativeStar(lastPair)) {
    explanation += " - L∆∞u √Ω: K·∫øt th√∫c b·∫±ng hung tinh (kh√¥ng t·ªët)"
  }
  
  // Ki·ªÉm tra n·∫øu c√≥ 2 hung tinh li·ªÅn k·ªÅ
  let hasConsecutiveNegativeStars = false
  for (let i = 0; i < pairs.length - 1; i++) {
    const currentStarIsNegative = pairs[i].includes("Ng≈© Qu·ª∑") || pairs[i].includes("Tuy·ªát M·ªánh") || 
                                  pairs[i].includes("L·ª•c S√°t") || pairs[i].includes("H·ªça H·∫°i");
    
    const nextStarIsNegative = pairs[i+1].includes("Ng≈© Qu·ª∑") || pairs[i+1].includes("Tuy·ªát M·ªánh") || 
                              pairs[i+1].includes("L·ª•c S√°t") || pairs[i+1].includes("H·ªça H·∫°i");
    
    if (currentStarIsNegative && nextStarIsNegative) {
      hasConsecutiveNegativeStars = true;
      break;
    }
  }
  
  if (hasConsecutiveNegativeStars) {
    explanation += " - L∆∞u √Ω: C√≥ hai hung tinh li·ªÅn k·ªÅ (kh√¥ng t·ªët)"
  }
  
  return explanation
}

const isNegativeStar = (pair) => {
  return starNumbers.NGU_QUY.includes(pair) || 
         starNumbers.TUYET_MENH.includes(pair) || 
         starNumbers.LUC_SAT.includes(pair) || 
         starNumbers.HOA_HAI.includes(pair);
}

const isValidLastDigit = (digit) => {
  // S·ªë cu·ªëi kh√¥ng ph·∫£i l√† 0
  return digit !== '0';
}

const isValidWithLastDigit5 = (secondLastDigit) => {
  // N·∫øu s·ªë cu·ªëi l√† 5, ki·ªÉm tra s·ªë k·ªÅ tr∆∞·ªõc c√≥ t·∫°o th√†nh c√°t tinh kh√¥ng
  for (const key of ['SINH_KHI', 'THIEN_Y', 'DIEN_NIEN', 'PHUC_VI']) {
    if (starNumbers[key].some(pair => pair.startsWith(secondLastDigit))) {
      return true;
    }
  }
  return false;
}

const generatePhoneNumbers = () => {
  if (!selectedPurpose.value || !selectedProvider.value) return
  
  const combinations = fengShuiData[selectedPurpose.value].combinations
  const luckyNumbers = fengShuiData[selectedPurpose.value].luckyNumbers
  
  suggestedPhoneNumbers.value = []
  phoneExplanations.value = []
  
  for (let i = 0; i < 4; i++) {
    let phone = '';
    let validPhone = false;
    let negativePairAdded = false;
    let attemptCount = 0;
    const maxAttempts = 100; // Gi·ªõi h·∫°n s·ªë l·∫ßn th·ª≠ ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n
    
    while (!validPhone && attemptCount < maxAttempts) {
      attemptCount++;
      
      // ƒê·∫ßu s·ªë
      phone = selectedProvider.value;
      negativePairAdded = false;
      
      // Th√™m 7 ch·ªØ s·ªë ti·∫øp theo
      let previousDigit = phone.charAt(phone.length - 1);
      
      // T·∫°o ƒë·ªß 7 ch·ªØ s·ªë c√≤n l·∫°i
      let isComplete = true;
      
      for (let j = 0; j < 7; j++) {
        // Ch·ªØ s·ªë cu·ªëi c√πng c·∫ßn ki·ªÉm tra ƒë·∫∑c bi·ªát
        if (j === 6) {
          let validLastDigits = luckyNumbers.filter(num => {
            // Ki·ªÉm tra s·ªë cu·ªëi kh√¥ng ph·∫£i l√† 0
            if (num === '0') return false;
            
            // Ki·ªÉm tra n·∫øu s·ªë cu·ªëi l√† 5 th√¨ c·∫∑p s·ªë tr∆∞·ªõc ph·∫£i l√† c√°t tinh
            if (num === '5') {
              return isValidWithLastDigit5(previousDigit);
            }
            
            // Ki·ªÉm tra c·∫∑p cu·ªëi kh√¥ng ph·∫£i l√† hung tinh
            const potentialPair = previousDigit + num;
            return !isNegativeStar(potentialPair);
          });
          
          if (validLastDigits.length > 0) {
            const randomIndex = Math.floor(Math.random() * validLastDigits.length);
            const safeNumber = validLastDigits[randomIndex];
            phone += safeNumber;
            previousDigit = safeNumber;
          } else {
            // N·∫øu kh√¥ng t√¨m ƒë∆∞·ª£c s·ªë h·ª£p l·ªá, ƒë√°nh d·∫•u l·∫ßn th·ª≠ n√†y kh√¥ng th√†nh c√¥ng
            isComplete = false;
            break;
          }
        } else {
          // N·∫øu b·∫≠t t√πy ch·ªçn th√™m hung tinh v√† ch∆∞a th√™m
          if (includeNegativeStar.value && !negativePairAdded && j >= 1 && j <= 4) {
            // X√°c su·∫•t 30% ƒë·ªÉ th√™m hung tinh t·∫°i v·ªã tr√≠ n√†y (gi·∫£m t·ª´ 40% xu·ªëng 30%)
            if (Math.random() < 0.3) {
              // Ki·ªÉm tra ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng c√≥ 2 hung tinh li·ªÅn k·ªÅ
              let canAddNegativeStar = true;
              
              // Ki·ªÉm tra xem ch·ªØ s·ªë tr∆∞·ªõc c√≥ t·∫°o th√†nh hung tinh v·ªõi ch·ªØ s·ªë ti·∫øp theo kh√¥ng
              for (const key of ['NGU_QUY', 'TUYET_MENH', 'LUC_SAT', 'HOA_HAI']) {
                if (starNumbers[key].some(pair => pair.endsWith(previousDigit))) {
                  canAddNegativeStar = false;
                  break;
                }
              }
              
              if (canAddNegativeStar) {
                // T√¨m m·ªôt hung tinh ph√π h·ª£p b·∫Øt ƒë·∫ßu b·∫±ng previousDigit
                const negativePair = getNegativeStarForBalance(previousDigit);
                
                if (negativePair) {
                  // Th√™m ch·ªØ s·ªë ti·∫øp theo t·ª´ hung tinh
                  const nextDigit = negativePair.charAt(1);
                  phone += nextDigit;
                  previousDigit = nextDigit;
                  negativePairAdded = true;
                  continue;
                }
              }
            }
          }
          
          // V·ªõi c√°c ch·ªØ s·ªë kh√¥ng ph·∫£i cu·ªëi c√πng
          // Ki·ªÉm tra kh√¥ng c√≥ hai hung tinh li·ªÅn k·ªÅ
          const availableNumbers = luckyNumbers.filter(num => {
            const potentialPair = previousDigit + num;
            return !isNegativeStar(potentialPair);
          });
          
          if (availableNumbers.length > 0) {
            const randomIndex = Math.floor(Math.random() * availableNumbers.length);
            const safeNumber = availableNumbers[randomIndex];
            phone += safeNumber;
            previousDigit = safeNumber;
          } else {
            // N·∫øu kh√¥ng t√¨m ƒë∆∞·ª£c s·ªë an to√†n, d√πng s·ªë ng·∫´u nhi√™n t·ª´ m·∫£ng may m·∫Øn
            const randomLuckyNumber = luckyNumbers[Math.floor(Math.random() * luckyNumbers.length)];
            phone += randomLuckyNumber;
            previousDigit = randomLuckyNumber;
          }
        }
      }
      
      // N·∫øu kh√¥ng t·∫°o ƒë·ªß c√°c ch·ªØ s·ªë, th·ª≠ l·∫°i
      if (!isComplete) continue;
      
      // Ki·ªÉm tra ƒë·ªô d√†i ƒë·ªß 10 s·ªë v√† kh√¥ng c√≥ hung tinh ·ªü cu·ªëi
      if (phone.length === 10) {
        // Ki·ªÉm tra cu·ªëi c√πng kh√¥ng c√≥ hung tinh v√† kh√¥ng ph·∫£i s·ªë 0
        const lastDigit = phone.slice(-1);
        const lastPair = phone.slice(-2);
        
        if (isValidLastDigit(lastDigit) && !isNegativeStar(lastPair)) {
          // N·∫øu s·ªë cu·ªëi l√† 5, ki·ªÉm tra th√™m c·∫∑p s·ªë tr∆∞·ªõc
          if (lastDigit === '5') {
            const secondLastDigit = phone.slice(-2, -1);
            if (isValidWithLastDigit5(secondLastDigit)) {
              // N·∫øu y√™u c·∫ßu c√≥ hung tinh nh∆∞ng ch∆∞a th√™m ƒë∆∞·ª£c
              if (includeNegativeStar.value && !negativePairAdded) {
                // N·∫øu ƒë√£ th·ª≠ nhi·ªÅu l·∫ßn, b·ªè qua y√™u c·∫ßu hung tinh ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n
                if (attemptCount > maxAttempts / 2) {
                  validPhone = true;
                } else {
                  continue;
                }
              } else {
                validPhone = true;
              }
            }
          } else {
            // N·∫øu y√™u c·∫ßu c√≥ hung tinh nh∆∞ng ch∆∞a th√™m ƒë∆∞·ª£c
            if (includeNegativeStar.value && !negativePairAdded) {
              // N·∫øu ƒë√£ th·ª≠ nhi·ªÅu l·∫ßn, b·ªè qua y√™u c·∫ßu hung tinh ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n
              if (attemptCount > maxAttempts / 2) {
                validPhone = true;
              } else {
                continue;
              }
            } else {
              validPhone = true;
            }
          }
        }
      }
    }
    
    // N·∫øu kh√¥ng t√¨m ƒë∆∞·ª£c s·ªë h·ª£p l·ªá sau s·ªë l·∫ßn th·ª≠ t·ªëi ƒëa
    if (!validPhone) {
      // T·∫°o m·ªôt s·ªë b·∫•t k·ª≥ ph√π h·ª£p, kh√¥ng quan t√¢m ƒë·∫øn ƒëi·ªÅu ki·ªán hung tinh
      phone = selectedProvider.value;
      for (let j = 0; j < 7; j++) {
        const randomIndex = Math.floor(Math.random() * luckyNumbers.length);
        phone += luckyNumbers[randomIndex];
      }
    }
    
    // ƒê·ªãnh d·∫°ng s·ªë ƒëi·ªán tho·∫°i th√†nh d·∫°ng xxxx xxx xxx
    const formattedPhone = `${phone.substring(0, 4)} ${phone.substring(4, 7)} ${phone.substring(7, 10)}`;
    
    suggestedPhoneNumbers.value.push(formattedPhone);
    phoneExplanations.value.push(generatePhoneExplanation(phone));
  }
}

const copyToClipboard = (text) => {
  // X√≥a d·∫•u c√°ch khi sao ch√©p
  const cleanText = text.replace(/\s/g, '');
  
  // T·∫°o m·ªôt text area t·∫°m th·ªùi
  const textArea = document.createElement('textarea');
  textArea.value = cleanText;
  textArea.style.position = 'fixed';
  textArea.style.left = '-999999px';
  textArea.style.top = '-999999px';
  document.body.appendChild(textArea);
  
  // Ch·ªçn v√† sao ch√©p
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      alert('ƒê√£ sao ch√©p: ' + cleanText);
    } else {
      alert('Kh√¥ng th·ªÉ sao ch√©p s·ªë ƒëi·ªán tho·∫°i');
    }
  } catch (err) {
    console.error('L·ªói khi sao ch√©p: ', err);
    alert('Kh√¥ng th·ªÉ sao ch√©p: ' + err);
  }
  
  // X√≥a text area
  document.body.removeChild(textArea);
}

// Theo d√µi thay ƒë·ªïi v√† t·∫°o g·ª£i √Ω m·ªõi
watch([selectedPurpose, selectedProvider, includeNegativeStar], () => {
  if (selectedPurpose.value && selectedProvider.value) {
    generatePhoneNumbers()
  }
})

// X·ª≠ l√Ω s·ª± ki·ªán ƒëi·ªÅu h∆∞·ªõng t·ª´ Header
const handleNavigate = (path) => {
  router.push(path)
}
</script>

<style scoped>
:root {
  --primary-color: #4361ee;
  --primary-light: #e7ecfd;
  --primary-dark: #3a50d8;
}

.text-primary { color: var(--primary-color); }
.bg-primary { background-color: var(--primary-color); }
.border-primary { border-color: var(--primary-color); }
.bg-primary-light { background-color: var(--primary-light); }
.bg-primary-dark { background-color: var(--primary-dark); }
.hover\:border-primary:hover { border-color: var(--primary-color); }
.hover\:bg-primary-dark:hover { background-color: var(--primary-dark); }

/* Tailwind CSS kh√¥ng t·ª± ƒë·ªông nh·∫≠n bi·∫øt CSS variables, n√™n ch√∫ng ta c·∫ßn th√™m m·ªôt s·ªë class t√πy ch·ªânh */
.bg-primary-color {
  background-color: var(--primary-color, #4361ee);
}

.bg-primary-dark {
  background-color: var(--primary-dark, #3a56d4);
}

.bg-primary-light {
  background-color: var(--primary-light, #e7ecfd);
}

.text-primary-color {
  color: var(--primary-color, #4361ee);
}
</style>